<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>ADAS — Realtime Emotions & Alerts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen">
<div class="max-w-4xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">ADAS — WebSocket Tester</h1>

    <!-- Connect -->
    <div class="flex gap-2 mb-4">
        <input id="wsUrl" class="border px-3 py-2 rounded w-2/3"
               value="http://localhost:8080/ws" />
        <button id="connectBtn" class="px-4 py-2 bg-emerald-600 text-white rounded">Connect</button>
        <button id="disconnectBtn" class="px-4 py-2 bg-gray-400 text-white rounded" disabled>Disconnect</button>
    </div>

    <!-- Subscription -->
    <div class="mb-4">
        <label class="block text-sm mb-1">Session ID</label>
        <input id="sessionId" placeholder="UUID of session" class="border px-3 py-2 rounded w-full" />
        <button id="subscribeBtn" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded" disabled>Subscribe</button>
    </div>

    <!-- Feeds -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded shadow p-4">
            <h2 class="font-semibold mb-2">Emotions Feed</h2>
            <div id="emotionsLog" class="h-80 overflow-auto bg-slate-50 border rounded p-2 text-xs font-mono"></div>
        </div>

        <div class="bg-white rounded shadow p-4">
            <h2 class="font-semibold mb-2">Alerts Feed</h2>
            <div id="alertsLog" class="h-80 overflow-auto bg-slate-50 border rounded p-2 text-xs font-mono"></div>
        </div>
    </div>

    <!-- Console -->
    <div class="bg-white rounded shadow p-4 mt-6">
        <h2 class="font-semibold mb-2">Console</h2>
        <pre id="log" class="h-48 overflow-auto bg-slate-50 border rounded p-2 text-xs"></pre>
    </div>
</div>

<script>
    let stompClient = null;
    let connected = false;

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      document.getElementById("log").textContent += `[${time}] ${msg}\n`;
    }

    function appendMessage(containerId, msg) {
      const div = document.createElement("div");
      div.className = "mb-2 p-2 bg-white border rounded";
      div.textContent = msg;
      const el = document.getElementById(containerId);
      el.appendChild(div);
      el.scrollTop = el.scrollHeight;
    }

    document.getElementById("connectBtn").onclick = function () {
      const url = document.getElementById("wsUrl").value.trim();
      const socket = new SockJS(url);
      stompClient = Stomp.over(socket);
      stompClient.debug = null;
      stompClient.connect({}, function (frame) {
        log("Connected: " + frame);
        connected = true;
        document.getElementById("disconnectBtn").disabled = false;
        document.getElementById("subscribeBtn").disabled = false;
      });
    };

    document.getElementById("disconnectBtn").onclick = function () {
      if (stompClient) {
        stompClient.disconnect(() => {
          log("Disconnected");
          connected = false;
          document.getElementById("disconnectBtn").disabled = true;
          document.getElementById("subscribeBtn").disabled = true;
        });
      }
    };

    document.getElementById("subscribeBtn").onclick = function () {
      if (!connected) return;
      const sessionId = document.getElementById("sessionId").value.trim();
      if (!sessionId) {
        log("Please enter a Session ID");
        return;
      }
      const emotionsDest = `/topic/emotions.session.${sessionId}`;
      const alertsDest   = `/topic/alerts.session.${sessionId}`;

      log("Subscribing to " + emotionsDest);
      stompClient.subscribe(emotionsDest, (msg) => {
        appendMessage("emotionsLog", msg.body);
      });

      log("Subscribing to " + alertsDest);
      stompClient.subscribe(alertsDest, (msg) => {
        appendMessage("alertsLog", msg.body);
      });
    };
</script>
</body>
</html>
