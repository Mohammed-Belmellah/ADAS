<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>ADAS — Realtime Emotions & Alerts</title>
    <!-- Tailwind for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SockJS + STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body class="bg-slate-50 min-h-screen">
<div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-slate-800">ADAS — Realtime Emotions & Alerts</h1>
        <div class="flex gap-2">
            <button id="connectBtn" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Connect</button>
            <button id="disconnectBtn" class="px-4 py-2 rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300" disabled>Disconnect</button>
        </div>
    </header>

    <!-- Connection settings -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-xl shadow p-4">
            <h2 class="font-semibold text-slate-700 mb-3">Server</h2>
            <label class="block text-sm text-slate-500">WebSocket URL</label>
            <input id="wsUrl" class="w-full mt-1 px-3 py-2 border rounded-lg" value="http://localhost:8080/ws" />
            <p class="text-xs text-slate-500 mt-2">This must match your Spring endpoint in <code>@EnableWebSocketMessageBroker</code>.</p>
        </div>

        <div class="bg-white rounded-xl shadow p-4">
            <h2 class="font-semibold text-slate-700 mb-3">Subscribe to Alerts</h2>
            <div class="grid grid-cols-1 gap-2">
                <div>
                    <label class="block text-sm text-slate-500">Session ID</label>
                    <input id="sessionId" class="w-full mt-1 px-3 py-2 border rounded-lg" placeholder="session UUID" />
                </div>
                <div>
                    <label class="block text-sm text-slate-500">Driver ID</label>
                    <input id="driverId" class="w-full mt-1 px-3 py-2 border rounded-lg" placeholder="driver UUID (optional)" />
                </div>
                <div>
                    <label class="block text-sm text-slate-500">Company ID</label>
                    <input id="companyId" class="w-full mt-1 px-3 py-2 border rounded-lg" placeholder="company UUID (optional)" />
                </div>
                <button id="subscribeAlertsBtn" class="mt-2 px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700" disabled>
                    Subscribe to Alerts
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow p-4">
            <h2 class="font-semibold text-slate-700 mb-3">Send Test Batch</h2>
            <label class="block text-sm text-slate-500">Session ID</label>
            <input id="sendSessionId" class="w-full mt-1 px-3 py-2 border rounded-lg" placeholder="session UUID to send to" />
            <button id="sendBtn" class="mt-3 w-full px-3 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700" disabled>
                Send Emotion Batch
            </button>
            <p class="text-xs text-slate-500 mt-2">Sends to <code>/app/emotions/batch</code>.</p>
        </div>
    </section>

    <!-- Feeds -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-slate-700">Emotions Feed</h3>
                <span id="emotionStatus" class="text-xs px-2 py-1 rounded bg-slate-100 text-slate-600">Not subscribed</span>
            </div>
            <div id="emotionsLog" class="h-80 overflow-auto font-mono text-sm bg-slate-50 rounded-lg p-3 border"></div>
        </div>

        <div class="bg-white rounded-xl shadow p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-slate-700">Alerts Feed</h3>
                <span id="alertsStatus" class="text-xs px-2 py-1 rounded bg-slate-100 text-slate-600">Not subscribed</span>
            </div>
            <div id="alertsList" class="space-y-2 h-80 overflow-auto"></div>
        </div>
    </section>

    <!-- Console -->
    <section class="bg-white rounded-xl shadow p-4 mt-6">
        <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold text-slate-700">Console</h3>
            <button id="clearLogBtn" class="text-sm px-3 py-1 rounded bg-slate-200 hover:bg-slate-300">Clear</button>
        </div>
        <pre id="log" class="h-48 overflow-auto bg-slate-50 p-3 rounded border text-xs"></pre>
    </section>
</div>

<script>
    let stompClient = null;
    let connected = false;

    const logEl = document.getElementById("log");
    const emotionsLogEl = document.getElementById("emotionsLog");
    const alertsListEl = document.getElementById("alertsList");
    const connectBtn = document.getElementById("connectBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");
    const sendBtn = document.getElementById("sendBtn");
    const subscribeAlertsBtn = document.getElementById("subscribeAlertsBtn");
    const emotionStatus = document.getElementById("emotionStatus");
    const alertsStatus = document.getElementById("alertsStatus");

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function appendEmotion(message) {
      try {
        const payload = JSON.parse(message.body);
        const pretty = JSON.stringify(payload, null, 2);
        const div = document.createElement("div");
        div.className = "mb-2 p-2 bg-white border rounded";
        div.innerHTML = `<pre class="text-xs">${pretty}</pre>`;
        emotionsLogEl.appendChild(div);
        emotionsLogEl.scrollTop = emotionsLogEl.scrollHeight;
      } catch (e) {
        emotionsLogEl.textContent += message.body + "\n";
      }
    }

    function badgeForType(type) {
      const t = (type || "").toUpperCase();
      if (t.includes("FATIGUE")) return "bg-rose-100 text-rose-700";
      if (t.includes("PEAK")) return "bg-amber-100 text-amber-700";
      if (t.includes("AGGRESS") || t.includes("ANGRY")) return "bg-orange-100 text-orange-700";
      return "bg-sky-100 text-sky-700";
    }

    function appendAlert(message) {
      log("Received alert message: " + message.body); // Debug log
      let data;
      try {
        data = JSON.parse(message.body);
        log("Parsed alert data: " + JSON.stringify(data)); // Debug log
      } catch (e) {
        log("Failed to parse alert JSON: " + e.message);
        data = { raw: message.body, type: "PARSE_ERROR" };
      }
      const div = document.createElement("div");
      div.className = "p-3 border rounded-lg bg-white";
      const when = data.createdAt ? new Date(data.createdAt).toLocaleString() : new Date().toLocaleString();
      const badge = badgeForType(data.type);
      div.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="font-medium text-slate-800">Alert: ${data.type || "UNKNOWN"}</div>
          <span class="text-xs px-2 py-1 rounded ${badge}">${data.type || "?"}</span>
        </div>
        <div class="text-slate-600 text-sm mt-1">${data.message || ""}</div>
        <div class="text-slate-400 text-xs mt-1">at ${when}</div>
      `;
      alertsListEl.prepend(div);
      alertsListEl.scrollTop = 0;
    }

    function setConnected(state) {
      connected = state;
      connectBtn.disabled = state;
      disconnectBtn.disabled = !state;
      sendBtn.disabled = !state;
      subscribeAlertsBtn.disabled = !state;
      emotionStatus.textContent = state ? "Subscribed to /topic/emotions" : "Not subscribed";
    }

    // Connect
    connectBtn.onclick = function () {
      const url = document.getElementById("wsUrl").value.trim();
      const socket = new SockJS(url);
      stompClient = Stomp.over(socket);

      // Optional: auto-reconnect (stompjs 2.x)
      stompClient.reconnect_delay = 5000;

      // Quiet logs (set to console.log to debug)
      stompClient.debug = null;

      stompClient.connect({}, function (frame) {
        log("Connected: " + frame);
        setConnected(true);

        // Emotions feed
        stompClient.subscribe("/topic/emotions", appendEmotion);
        emotionStatus.textContent = "Subscribed: /topic/emotions";

        // If sessionId provided, auto-sub alerts for this session
        const sid = document.getElementById("sessionId").value.trim();
        if (sid) {
          // Use dot notation for RabbitMQ compatibility
          const dest = `/topic/alerts.session.${sid}`;
          log("Subscribing to " + dest);
          stompClient.subscribe(dest, msg => {
            alertsStatus.textContent = `Subscribed: ${dest}`;
            appendAlert(msg);
          });
        } else {
          alertsStatus.textContent = "Ready — provide IDs and click Subscribe";
        }
      }, function (error) {
        log("STOMP error: " + error);
        setConnected(false);
      });
    };

    // Disconnect
    disconnectBtn.onclick = function () {
      if (stompClient) {
        stompClient.disconnect(() => {
          log("Disconnected");
          setConnected(false);
        });
      }
    };

    // Subscribe to alerts based on inputs
    subscribeAlertsBtn.onclick = function () {
      if (!connected) return;

      const sid = document.getElementById("sessionId").value.trim();
      const did = document.getElementById("driverId").value.trim();
      const cid = document.getElementById("companyId").value.trim();

      let destinations = [];

      // Use dot notation for RabbitMQ compatibility
      if (sid) destinations.push(`/topic/alerts.session.${sid}`);
      if (did) destinations.push(`/topic/alerts.driver.${did}`);
      if (cid) destinations.push(`/topic/alerts.company.${cid}`);

      if (destinations.length === 0) {
        alertsStatus.textContent = "Please enter at least one ID to subscribe.";
        return;
      }

      destinations.forEach(dest => {
        log("Subscribing to " + dest);
        stompClient.subscribe(dest, appendAlert);
      });

      alertsStatus.textContent = "Subscribed: " + destinations.join(", ");
    };

    // Send test batch
    sendBtn.onclick = function () {
      if (!connected) return;
      const sessionId = document.getElementById("sendSessionId").value.trim();
      if (!sessionId) {
        log("Please provide a Session ID to send to.");
        return;
      }
      const payload = {
        sessionId,
        records: [
          {
            emotions: ["happy", "neutral", "angry"],
            confidences: [0.85, 0.10, 0.05],
            detectedAt: new Date(Date.now() - 60_000).toISOString().slice(0,19)
          },
          {
            emotions: ["tired", "neutral", "happy"],
            confidences: [0.70, 0.20, 0.10],
            detectedAt: new Date().toISOString().slice(0,19)
          }
        ]
      };
      stompClient.send("/app/emotions/batch", {}, JSON.stringify(payload));
      log("Sent batch to /app/emotions/batch");
    };

    document.getElementById("clearLogBtn").onclick = () => logEl.textContent = "";
</script>
</body>
</html>